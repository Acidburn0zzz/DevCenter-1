---
layout: tutorial
title: 'NEW: Offline Authentication'
relevantTo: [hybrid]
---
<ul>
<li class="download-sample">
          <a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v630/OfflineAuthenticationProject.zip">Download Studio project</a>
        </li>
</ul>

<h2>Overview</h2>
<p>This tutorial explains a sample implementation of offline user authentication.<br />
The goal of offline authentication is to make the login/logout end-user experience consistent whether online or offline.</p>
<h3>Prerequisites:</h3>
<p>It is assumed that the developer is familiar with IBM MobileFirst Platform Foundation application development, adapter-based authentication and JSONStore.<br />
The associated sample project demonstrates an end-to-end scenario. However, there are many ways to achieve the same results.</p>
<p>Topics covered, are:</p>
<ul>
<li><a href="#offlineAuthenticationConcept">Offline authentication concept</a></li>
<li><a href="#implementingAuthenticationFlows">Implementing the authentication flows</a></li>
<li><a href="#sampleApplication">Sample application</a></li>
</ul>
<h2 id="offlineAuthenticationConcept">Offline authentication concept</h2>
<p>By using offline authentication, an end-user is able to authenticate even if an Internet connection is unavailable.</p>
<p>An <em>Online login</em> is necessary when logging-in is attempted for the first time, so that the MobileFirst Server validates the user’s credentials. After successful validation, a JSONStore is created for the logged-in user. The Offline authentication is implemented by opening the mentioned JSONStore for the supplied username and password. This is further explained below.</p>
<p>The sample application for this tutorial has the following structure:</p>
<ul>
<li>An unsecured area, which is accessible without authentication</li>
<li>A secured area, which is accessible only after authentication, whether online or offline</li>
<li>The same login form for both online and offline authentication, so that the end-user experience is the same whether online and offline</li>
<li>Support for logging-out</li>
</ul>
<p>Going through the online and offline flows from a high-level point of view:</p>
<h4>Step 1:</h4>
<p>Before either online or offline authentication occurs, an Internet connection is checked for first. Depending on the result, the appropriate authentication flow is used.</p>
<h3>Online Authentication</h3>
<h4>Steps 2 and 3:</h4>
<p>The online authentication flow is implemented as explained in the <a href="../../authentication-security/adapter-based-authentication/adapter-based-authentication-hybrid-applications/" title="Adapter-based authentication in hybrid applications">adapter-based authentication in hybrid applications</a> tutorial.</p>
<h4>Steps 4 and 5:</h4>
<p>After a successful login, a JSONStore is created using the end-user’s username and encrypted using the user's password.</p>
<h4>Step 6:</h4>
<p>The secured area is displayed.</p>
<p><img src="{{ site.baseurl }}/assets/backup/09_18_online-flow.png"/></p>
<h3>Offline Authentication</h3>
<h4>Steps 2 and 3:</h4>
<p>The authentication process tries to open the previously created JSONStore by using the end-user’s password that was passed as input.</p>
<h4>Step 4:</h4>
<p>If the attempt is successful, the secured area is displayed.</p>
<p><img src="{{ site.baseurl }}/assets/backup/09_18_offline_flow.png"/></p>
<h2 id="implementingAuthenticationFlows">Implementing the authentication flows</h2>
<p>Keep in mind that some of the implementation code relates to the application UI.<br />
You can find the rest of the application code (HTML, CSS, additional JavaScript) in the provided sample application.</p>
<p>The <span class="inline-code">username</span>, <span class="inline-code">password</span> and <span class="inline-code">offlineLoggedIn</span> global variables help determine the user’s login state, whether connected or not connected to the Internet.<br />
{% highlight javascript %}<br />
var username = null, password = null;<br />
var offlineLoggedIn = false;<br />
{% endhighlight %}</p>
<p><strong>Prerequisite:</strong> When an end-user tries to log in for the very first time, Internet connection must be available so that the user credentials can be verified against the server backend.</p>
<p>Therefore, before any authentication is performed, Internet connection is checked so that the appropriate authentication flow is executed.<br />
{% highlight javascript %}<br />
function goToSecuredArea() {<br />
    WL.Device.getNetworkInfo(<br />
        function (networkInfo) {<br />
            if (networkInfo.isNetworkConnected == "true") {<br />
                onlineAuthentication();<br />
            } else {<br />
                offlineAuthentication();<br />
            }<br />
        }<br />
    );<br />
}<br />
{% endhighlight %}</p>
<h3>Implementation notes</h3>
<h4>Single-Step Authentication</h4>
<ol>
<li>The online authentication flow uses the same code as provided in the <a href="../../authentication-security/adapter-based-authentication/" title="Adapter-based authentication">single-step adapter authentication sample application</a>.
</li>
<li>In order to simulate a back-end of multiple users, a valid login is considered one where the <span class="inline-code">username == password</span>, no matter what the username is.
<p>The <span class="inline-code">submitAuthentication</span> function in the adapter's <span class="inline-code">*-impl.js</span> file is therefore modified to:<br />
{% highlight javascript %}<br />
function submitAuthentication (username, password){<br />
    if (username == password) {<br />
{% endhighlight %}</li>
</ol>
<h4>JSONStore</h4>
<p>Because the authentication simulates multiple users, usage of multiple JSONStores is required as well, in order to accommodate for the many users.</p>
<p>Thus, in <span class="inline-code">WL.JSONStore.init</span>, the username is passed as a parameter for a new JSONStore to be opened for each authenticated user. For this, declare a collection to define the structure of the JSONStore:<br />
{% highlight javascript %}<br />
var collectionName = "userCredentials";<br />
var collections = {<br />
    userCredentials : {<br />
        searchFields : {<br />
            collectionNotEmpty: "string"<br />
        }<br />
    }<br />
};<br />
{% endhighlight %}</p>
<p>Next,</p>
<h3>Online authentication</h3>
<p>Below is the complete implementation, followed by a breakdown and explanation code block by code block.<br />
The sample application contains additional comments.</p>
<p>{% highlight javascript %}<br />
function onlineAuthentication() {<br />
  if (WL.Client.isUserAuthenticated("myCustomRealm")) {<br />
    if (username == null) {<br />
      WL.Client.logout("myCustomRealm", {<br />
        onSuccess: function() {<br />
          onlineAuthentication();<br />
        },<br />
        onFailure: function() {<br />
          WL.SimpleDialog.show("Logout", "Unable to logout at this time. Try again later.", [{<br />
            text: "OK",<br />
            handler: function() {}<br />
          }]);<br />
        }<br />
      });<br />
    } else {<br />
      displaySecuredArea();<br />
    }<br />
  } else if (username) {<br />
    var invocationData = {<br />
      adapter: "authenticationAdapter",<br />
      procedure: "submitAuthentication",<br />
      parameters: [$("#username").val(), $("#password").val()]<br />
    };</p>
<p>    myCustomRealmChallengeHandler.submitAdapterAuthentication(<br />
      invocationData, {<br />
        onSuccess: onlineAuthenticationSuccess,<br />
        onFailure: onlineAuthenticationFailure<br />
      });<br />
  } else {<br />
    WL.Client.login("myCustomRealm", {<br />
      onSuccess: onlineAuthenticationSuccess,<br />
      onFailure: onlineAuthenticationFailure<br />
    });<br />
  }<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>Check whether the user is already authenticated<br />
If <span class="inline-code">true</span>, display the secured area.<br />
If <span class="inline-code">false</span>, display the login form and start authentication via the challenge handler.</i></p>
<p>{% highlight javascript %}<br />
function onlineAuthentication() {<br />
  if (WL.Client.isUserAuthenticated("myCustomRealm")) {<br />
    if (username == null) {<br />
      //...<br />
      });<br />
    } else {<br />
      displaySecuredArea();<br />
    }<br />
  } else if (username) {<br />
    //...<br />
  } else {<br />
    WL.Client.login("myCustomRealm", {<br />
      onSuccess: onlineAuthenticationSuccess,<br />
      onFailure: onlineAuthenticationFailure<br />
    });<br />
  }<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>If the connection to the Internet is established and the user is authenticated on the back end but the username variable is empty, assume that a logout happened offline.<br />
Log out the user from the realm before trying to log in again online.</i></p>
<p>{% highlight javascript %}<br />
if (WL.Client.isUserAuthenticated("myCustomRealm")) {<br />
  if (username == null) {<br />
    WL.Client.logout("myCustomRealm", {<br />
      onSuccess: function() {<br />
        onlineAuthentication();<br />
      },<br />
      onFailure: function() {<br />
        WL.SimpleDialog.show("Logout", "Unable to logout at this time. Try again later.", [{<br />
          text: "OK",<br />
          handler: function() {}<br />
        }]);<br />
      }<br />
    });<br />
  } else {<br />
    displaySecuredArea();<br />
  }<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>If logging-in while offline and Internet connection is then available, log in to the realm without showing the login form.</i><br />
{% highlight javascript %}<br />
function onlineAuthentication() {<br />
  if (WL.Client.isUserAuthenticated("myCustomRealm")) {<br />
    //...<br />
  } else if (username) {<br />
    var invocationData = {<br />
      adapter: "authenticationAdapter",<br />
      procedure: "submitAuthentication",<br />
      parameters: [$("#username").val(), $("#password").val()]<br />
    };</p>
<p>    myCustomRealmChallengeHandler.submitAdapterAuthentication(<br />
      invocationData, {<br />
        onSuccess: onlineAuthenticationSuccess,<br />
        onFailure: onlineAuthenticationFailure<br />
      });<br />
  } else {<br />
    //...<br />
  }<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>If online authentication fails, for example if MobileFirst Server is unavailable, offline authentication is attempted instead.</i><br />
{% highlight javascript %}<br />
function onlineAuthenticationFailure() {<br />
    offlineAuthentication();<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /></p>
<h3>onlineAuthenticationSuccess</h3>
<p>Upon successful online authentication, the secured area can be displayed.</p>
<p>The username and password are saved for future use.<br />
A JSONStore for the user is initialized from the user’s username and encrypted by using the user’s password.</p>
<p>Before populating the collection, it is best to check whether it is already populated from a previous login attempt. Return the contents of the collection.<br />
If the collection is empty, populate it.<br />
If the collection is not empty, do not populate it again.</p>
<p>Finally, the username and password variables are emptied, the JSONStore is closed and the secured area is displayed.</p>
<p>{% highlight javascript %}<br />
function onlineAuthenticationSuccess() {<br />
    username = $("#username").val();<br />
    password = $("#password").val();</p>
<p>    WL.JSONStore.init(collections, {password:password, username:username, localKeyGen:true})<br />
    .then(function() {<br />
        return WL.JSONStore.get(collectionName).findAll();<br />
    })<br />
    .then(function(findAllResult) {<br />
        if (findAllResult.length == 0) {<br />
            // The JSONStore collection is empty, populate it.<br />
            var data = [{isEmpty:"false"}];<br />
            return WL.JSONStore.get(collectionName).add(data);<br />
        }<br />
    })<br />
    .then(function() {<br />
         password = null;<br />
         username = null;<br />
         WL.JSONStore.closeAll();<br />
         displaySecuredArea();<br />
    })<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /></p>
<h3>Offline authentication</h3>
<p>In the offline authentication flow, a couple of additional scenarios require dealing with:</p>
<ul>
<li>Empty username and password fields</li>
<li>First-time log-in when offline</li>
<li>Already authenticated users</li>
</ul>
<p>In online authentication, if <span class="inline-code">username != password</span>, the authentication process stops. In contrast, during offline authentication in JSONStore, the following cases must be addressed:</p>
<ul>
<li>Empty username and password fields destroy your JSONStore. As a result, users can no longer log in offline until the next online authentication, where the JSONStore is created again if it does not exist.</li>
<li>First-time log-in cannot happen because there is no JSONStore yet.</li>
</ul>
<p>{% highlight javascript %}<br />
function offlineAuthentication() {<br />
  $("#username").val('');<br />
  $("#password").val('');<br />
  $("#authInfo").empty();</p>
<p>  // Don't show the login form  if already offline-logged-in via JSONStore, or previously logged-in online (but have yet logged-out).<br />
  if (offlineLoggedIn === true || username) {<br />
    offlineLoggedIn = true;<br />
    displaySecuredAreaOffline();<br />
  } else {<br />
    // Prepare the login form.<br />
    $("#unsecuredDiv").hide();<br />
    $("#authDiv").show();<br />
    $("#offlineLoginButton").show();<br />
    $("#onlineLoginButton").hide();<br />
    $("#offlineLoginButton").unbind("click");<br />
    $("#offlineLoginButton").bind("click", function() {</p>
<p>      // Don't allow empty username/password field.<br />
      if (($("#username").val() == '') || ($("#password").val() == '')) {<br />
        $("#authInfo").html("Invalid credentials. Please try again.");<br />
      } else {<br />
        WL.JSONStore.init(collections, {<br />
            password: $("#password").val(),<br />
            username: $("#username").val(),<br />
            localKeyGen: true<br />
          })<br />
          .then(function() {<br />
            /*<br />
             * Need to handle the case where logging in when offline for the first time, in which case logging in cannot be done as there wouldn't be a<br />
             * JSONStore available yet.<br />
             */<br />
            WL.JSONStore.get(collectionName).count()<br />
              .then(function(countResult) {<br />
                if (countResult == 0) {<br />
                  WL.JSONStore.destroy($("#username").val());<br />
                  $("#authInfo").html("First time login must be done when Internet connection is available.");<br />
                  $("#username").val("");<br />
                  $("#password").val("");<br />
                } else {<br />
                  // Preserve the username and password, set the offline-logged-in flag and dislay the secured area.<br />
                  offlineLoggedIn = true;<br />
                  username = $("#username").val();<br />
                  password = $("#password").val();<br />
                  displaySecuredAreaOffline();<br />
                }<br />
              })<br />
          })<br />
          .fail(function() {<br />
            $("#authInfo").html("Invalid credentials. Please try again.");<br />
            $("#username").val("");<br />
            $("#password").val("");<br />
          })<br />
      }<br />
    });<br />
  }<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>This function first checks whether the user is already authenticated.</i><br />
{% highlight javascript %}<br />
  if (offlineLoggedIn === true || username) {<br />
    offlineLoggedIn = true;<br />
    displaySecuredAreaOffline();<br />
  }<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>If the user is not authenticated, offline authentication is attempted.<br />
Check the validity of the user credentials.<br />
If they are not valid, display an error message.<br />
If they are valid, try to open and decrypt the user’s JSONStore by using the user’s password.</i></p>
<p>{% highlight javascript %}<br />
    $("#offlineLoginButton").bind("click", function() {</p>
<p>      // Don't allow empty username/password field.<br />
      if (($("#username").val() == '') || ($("#password").val() == '')) {<br />
        $("#authInfo").html("Invalid credentials. Please try again.");<br />
      } else {<br />
        WL.JSONStore.init(collections, {<br />
            password: $("#password").val(),<br />
            username: $("#username").val(),<br />
            localKeyGen: true<br />
          })<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>Then, Check the contents of the store.<br />
If the store is empty, this user did not previously log in: no stored data in the collection.<br />
Destroy the store for this username and provide an appropriate error message.</i></p>
<p>{% highlight javascript %}<br />
          .then(function() {<br />
            /*<br />
             * Need to handle the case where logging in when offline for the first time, in which case logging in cannot be done as there wouldn't be a<br />
             * JSONStore available yet.<br />
             */<br />
            WL.JSONStore.get(collectionName).count()<br />
              .then(function(countResult) {<br />
                if (countResult == 0) {<br />
                  WL.JSONStore.destroy($("#username").val());<br />
                  $("#authInfo").html("First time login must be done when Internet connection is available.");<br />
                  $("#username").val('');<br />
                  $("#password").val('');<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>If the JSON store is NOT empty, set the <em>offlineLoggedIn</em> flag to <em>true</em> and display the secured area.</i></p>
<p>{% highlight javascript %}<br />
                } else {<br />
                  // Preserve the username and password, set the offline-logged-in flag and dislay the secured area.<br />
                  offlineLoggedIn = true;<br />
                  username = $("#username").val();<br />
                  password = $("#password").val();<br />
                  displaySecuredAreaOffline();<br />
                }<br />
{% endhighlight %}</p>
<p><br clear="all" /></p>
<h3>Logout</h3>
<p>{% highlight javascript %}<br />
function logout() {<br />
  password = null;<br />
  username = null;<br />
  WL.JSONStore.closeAll();<br />
  offlineLoggedIn = false;</p>
<p>  WL.Device.getNetworkInfo(<br />
    function(networkInfo) {<br />
      if (networkInfo.isNetworkConnected == "true") {<br />
        WL.Client.logout("myCustomRealm", {onSuccess: displayUnsecuredArea, onFailure: displayUnsecuredArea});<br />
      }<br />
    }<br />
  );</p>
<p>  displayUnsecuredArea();<br />
}<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>Upon logout, mark the user as logged out:<br />
Empty the username and password variables.<br />
Close the JSONStore.<br />
Set the <em>offlineLoggedIn</em> flag to false.</i></p>
<p>{% highlight javascript %}<br />
  password = null;<br />
  username = null;<br />
  WL.JSONStore.closeAll();<br />
  offlineLoggedIn = false;<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
<i>Check the Internet connection before logging out.<br />
If available, log out the user from the realm and display the unsecured area.</i></p>
<p>{% highlight javascript %}<br />
  WL.Device.getNetworkInfo(<br />
    function(networkInfo) {<br />
      if (networkInfo.isNetworkConnected == "true") {<br />
        WL.Client.logout("myCustomRealm", {onSuccess: displayUnsecuredArea, onFailure: displayUnsecuredArea});<br />
      }<br />
    }<br />
  );<br />
  displayUnsecuredArea();<br />
{% endhighlight %}</p>
<p><br clear="all" /><br />
If online logout fails (for example because MobileFirst Server is not available), logging out will take place anyway. See online authentication in case the <em>username</em> variable is empty.</p>
<h2>The end result</h2>
<p><strong>Note:</strong> The sample code that is written in this tutorial is only a suggestion. You can use other implementation methods.<br />
To use the sample:</p>
<ol>
<li>Import the MobileFirst project into MobileFirst Studio.</li>
<li>Deploy the adapter and application.</li>
<li>Launch the application on a device.</li>
<li>Start online and log in by using, for example, mobile/mobile as the username and password. The secured area is then displayed</li>
<li>Log out.</li>
<li>In the device settings, change to airplane mode and log in again. The secured area is then displayed, in “offline access”.</li>
</ol>
<h2 id="sampleApplication">Sample application</h2>
<p><a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v630/OfflineAuthenticationProject.zip">Click to download</a> the Studio project.</p>
<p><img src="{{ site.baseurl }}/assets/backup/09_18_results.png"/></p>
