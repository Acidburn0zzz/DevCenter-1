---
layout: tutorial
title: Two-Step adapter authentication
relevantTo: [hybrid]
---
<ul>
<li class="download-sample">
  <a href="https://github.com/MobileFirst-Platform-Developer-Center/TwoStepAuth" target="_blank">Download MobileFirst project</a>
        </li>
</ul>

<h2>Overview</h2>
<p>This tutorial demonstrates how to implement "Two-Step" adapter-based authentication.</p>
<p><em>Two-Step</em> means that after the initial authentication that uses, for example, a username and a password, an additional authentication step is required, such as a login pin, a secret word, or similar identification. In this example, a secret word is implemented for the second authentication step. The code snippets and sample application in this tutorial are based on the <a href="../../authentication-security/adapter-based-authentication/">existing adapter-based authentication sample</a>. The changes extend the application from <em>single-step</em> to <em>Two-Step</em>.</p>
<h3>Session-independent mode</h3>
<p>By default, MobileFirst Platform Foundation 7.1 applications run in a session-independent mode, meaning that you can no longer use HTTP sessions or global variables to persist data across requests. Instead, MobileFirst apps must use a third-party database to store applicative states.</p>
<blockquote><p>To learn more about the session-independent mode, see its topic in the user documentation.</p></blockquote>
<p>To demonstrate how to store user data, the tutorial uses the <code>WL.Server.getClientId</code> API and a Cloudant database.</p>
<h3>Agenda</h3>
<ul>
<li><a href="#cloudant">Prerequisite - Creating an IBM Cloudant account</a></li>
<li><a href="#config">Configuring the authenticationConfig.xml file</a></li>
<li><a href="#serverside">Creating the server-side authentication components</a></li>
<li><a href="#creatingTheClientsideAuthenticationComponents">Creating the client-side authentication components</a></li>
<li><a href="#sampleApplication">Sample application</a></li>
</ul>
<h2 id="cloudant">Prerequisite - Creating an IBM Cloudant account</h2>
<p>This sample uses IBM Cloudant Database to save user data. To run the sample and understand how to work with Cloudant, first <a href="https://cloudant.com/sign-up/" target="_blank">sign up for a free account</a> and create a database.<br />
Then proceed as follows:</p>
<ul>
<li>Change the database permissions - Follow the instructions in the <a href="https://cloudant.com/changing-database-permissions-tutorial/" target="_blank">Changing Database Permissions</a> tutorial.</li>
<li>Basic authentication - The basic authentication value is passed as part of every request to the database. Instead of using your username and password to identify, use base-64 encoding to generate a string that is created by concatenating the API <code>key</code> and <code>password</code>, separated by a column character in the following manner: <code>key:password</code>. You use it later to send requests to the database.<br />
For more information, read the Cloudant <a href="https://docs.cloudant.com/authentication.html#basic-authentication">Basic Authentication</a> documentation.</li>
</ul>
<h2 id="config">Configuring the authenticationConfig.xml file</h2>
<h3>Realms</h3>
<p>Add a realm or replace the existing <code>AuthLoginModule</code> realm in the <code>realms</code> section of the <code>authenticationConfig.xml</code> file:<br />
{% highlight xml %}<br />
  <realm loginModule="AuthLoginModule" name="TwoStepAuthRealm"><br />
    <className>com.worklight.integration.auth.AdapterAuthenticator</className><br />
      <parameter name="login-function" value="AuthAdapter.onAuthRequired"/><br />
      <parameter name="logout-function" value="AuthAdapter.onLogout"/><br />
  </realm><br />
{% endhighlight %}</p>
<h3>Security tests</h3>
<p>Add a security test or replace the existing <code>AuthSecurityTest</code> in the <code>securityTests</code> section of the <code>authenticationConfig.xml</code> file:<br />
{% highlight xml %}<br />
  <customSecurityTest name="TwoStepAuthAdapter-securityTest"><br />
      <test isInternalUserID="true" realm="TwoStepAuthRealm"/><br />
  </customSecurityTest><br />
{% endhighlight %}</p>
<blockquote><p>To review the remaining/existing sample components, see the <a href="../../authentication-security/adapter-based-authentication/">Adapter-based authentication</a> tutorial.</p></blockquote>
<h2 id="serverside">Creating the server-side authentication components</h2>
<p>To put in place the Two-Step authentication process, several changes are necessary to the adapter file (whether XML or JavaScript) and to the database.</p>
<h3>Adapter XML file</h3>
<p>Edit the <code>AuthAdapter.xml</code> file:</p>
<ol>
<li>Change the domain name to your Cloudant domain:<br />
{% highlight xml %}<br />
<domain>$USERNAME.cloudant.com</domain>{% endhighlight %}
</li>
<li>Add the following procedure:
<p>{% highlight xml %}<br />
<procedure name="submitAuthenticationStep2" securityTest="wl_unprotected"/><br />
{% endhighlight %}
</li>
<li>Protect the <code>getSecretData</code> method with the new <code>TwoStepAuthAdapter-securityTest<br />
</code></li>
</ol>
<h3>Adapter JavaScript file</h3>
<p>Edit the <code>AuthAdapter-impl.js</code> file:</p>
<ol>
<li>Create a variable to save the basic authentication encoded string you have generated before:<br />
{% highlight js %}<br />
var auth = "Basic REPLASE_ME_WITH_THE_BASE-64_ENCODED_STRING";;<br />
{% endhighlight %}
</li>
<li>Create a variable to save your database name:<br />
{% highlight js %}<br />
var dbName = "REPLACE_ME_WITH_THE_DATABASE_NAME";<br />
{% endhighlight %}
</li>
<li>Update the <code>onAuthRequired</code> function to return that authentication step 1 is required:<br />
{% highlight js %}<br />
function onAuthRequired(headers, errorMessage){<br />
	errorMessage = errorMessage ? errorMessage : null;<br />
	return {<br />
		authRequired: true,<br />
		authStep: 1,<br />
		errorMessage: errorMessage<br />
	};<br />
}{% endhighlight %}</li>
<li>Update the <code>submitAuthenticationStep1</code> function:
<ul>
<li>Add the following line to get the client ID:<br />
{% highlight js %}<br />
function submitAuthenticationStep1(username, password){<br />
	if (username === "user" &amp;&amp; password === "password"){<br />
		WL.Logger.debug("Step 1 :: SUCCESS");<br />
		var clientId = WL.Server.getClientId();<br />
		var userIdentity = {<br />
				userId: username,<br />
				displayName: username,<br />
				attributes: {}<br />
		};<br />
{% endhighlight %}
</li>
<li>To save the <code>userIdentity</code> for the next authentication step, write it to the database. Use the <code>clientId</code> variable as the document <code>_id</code> key:<br />
{% highlight js %}<br />
		//Validate that the DB doesn't already contains the ClientId<br />
		var response = deleteUserIdentityFromDB(dbName, null);</p>
<p>		//Write ClientId to DB<br />
		var response = writeUserIdentityToDB(dbName, {_id:clientId, "userIdentity":userIdentity});<br />
{% endhighlight %}
</li>
<li>If step 1 authentication was successful, return that step 2 is required:<br />
{% highlight js %}<br />
		if (response){<br />
			return {<br />
				authRequired: true,<br />
				authStep: 2,<br />
				question: "What is your pet's name?",<br />
				errorMessage : ""<br />
			};<br />
		} else {<br />
			return onAuthRequired(null, "Database ERROR");<br />
		}</p>
<p>	} else{<br />
		WL.Logger.debug("Step 1 :: FAILURE");<br />
		return onAuthRequired(null, "Invalid login credentials");<br />
	}<br />
}<br />
{% endhighlight %}
</li>
</ul>
</li>
<li>Add <code>submitAuthenticationStep2</code> function to handle the second authentication step:
<ul>
<li>Get the client ID and read it from the database:<br />
{% highlight js %}<br />
function submitAuthenticationStep2(answer){<br />
	var clientId = WL.Server.getClientId();<br />
	var response = readUserIdentityFromDB(dbName, clientId);<br />
{% endhighlight %}
</li>
<li>If step 2 authentication was successful, delete the client document from database:<br />
{% highlight js %}<br />
	if (response){<br />
		if (answer === "Lassie"){<br />
			var doc = JSON.parse(response.text);<br />
			var userIdentity = doc.userIdentity;<br />
			WL.Logger.debug("Step 2 :: SUCCESS");<br />
			WL.Server.setActiveUser("TwoStepAuthRealm", userIdentity);<br />
			WL.Logger.debug("Authorized access granted");</p>
<p>			var response = deleteUserIdentityFromDB(dbName, doc);</p>
<p>			return {<br />
				authRequired: false<br />
			};<br />
		} else{<br />
			WL.Logger.debug("Step 2 :: FAILURE");<br />
			return onAuthRequired(null, "Wrong security question answer");<br />
		}<br />
	} else {<br />
		WL.Logger.debug("Step 1 :: FAILURE");<br />
		return onAuthRequired(null, "Database ERROR");<br />
	}</p>
<p>}<br />
{% endhighlight %}
</li>
</ul>
</li>
</ol>
<h3>Database actions</h3>
<p>To handle the database actions, use the <code>WL.Server.invokeHttp</code> method and Cloudant REST API.</p>
<ul>
<li>Write to the database:<br />
{% highlight js %}<br />
function writeUserIdentityToDB(db, document){<br />
	   var input = {<br />
			   	method : 'post',<br />
		        returnedContentType : 'plain',<br />
		        path : db,<br />
		        headers: {<br />
		        	"Authorization":auth<br />
		        },<br />
		        body:{<br />
		        	contentType:'application/json; charset=UTF-8',<br />
		        	content:JSON.stringify(document)<br />
		    }};</p>
<p>		 var response = WL.Server.invokeHttp(input);<br />
		 var responseString = "" + response.statusCode;</p>
<p>		//Checking if the invocation was successful - status code = 2xx<br />
		 if (responseString.indexOf('2') === 0){<br />
			 return response;<br />
		 }<br />
		 return null;<br />
}<br />
{% endhighlight %}
</li>
<li>Read from database:<br />
{% highlight js %}<br />
function readUserIdentityFromDB(db, key){<br />
	 var input = {<br />
		        method : 'get',<br />
		        returnedContentType : 'plain',<br />
		        path : db + "/" + key,<br />
		        headers: {<br />
		        	"Authorization":auth<br />
		        	}<br />
		    };<br />
	 var response = WL.Server.invokeHttp(input);<br />
	 var responseString = "" + response.statusCode;</p>
<p>	 //Checking if the invocation was successful - status code = 2xx<br />
	 if (responseString.indexOf('2') === 0){<br />
		 return response;<br />
	 }<br />
	 return null;<br />
}<br />
{% endhighlight %}
</li>
<li>Delete from the database:<br />
{% highlight js %}<br />
function deleteUserIdentityFromDB(db, document){<br />
	var doc = document;<br />
	if (!doc){<br />
		var clientId = WL.Server.getClientId();<br />
		var response = readUserIdentityFromDB(dbName, clientId);<br />
		if(!response){<br />
			return;<br />
		} else {<br />
			doc = JSON.parse(response.text);<br />
		}<br />
	}<br />
	var id = doc._id; // The id of the doc to remove<br />
	var rev = doc._rev; // The rev of the doc to remove<br />
	var input = {<br />
		        method : 'delete',<br />
		        returnedContentType : 'plain',<br />
		        path : db + "/" + id + "?rev=" + rev,<br />
		        headers: {<br />
		        	"Authorization":auth<br />
		        	}<br />
		    };<br />
	 return WL.Server.invokeHttp(input);<br />
}<br />
{% endhighlight %}
</li>
</ul>
<blockquote><p>To learn more about IBM Cloudant REST API, see the Cloudant documentation.</p></blockquote>
<h2 id="creatingTheClientsideAuthenticationComponents">Creating the client-side authentication components</h2>
<ol>
<li>In <code>index.html</code>, use the <code>TwoStepAuthRealm</code> instead of the existing realm:
<p>{% highlight javascript %}<br />
<div id="AppDiv"><br />
      ...<br />
      <input type="button" class="appButton" value="Logout" onclick="WL.Client.logout('TwoStepAuthRealm', {onSuccess:WL.Client.reloadApp})" /><br />
      <div id="ResponseDiv"></div><br />
</div><br />
{% endhighlight %}</li>
<li>Add a second authentication screen:
<p>{% highlight html %}<br />
<div id="AuthStep2Div"><br />
    <h3>Authentication Step 2</h3><br />
    <p id="AuthQuestion"></p><br />
    <input type="text" placeholder="Enter answer" id="AuthAnswer"/><br /><br />
    <input type="button" class="formButton" value="Submit" id="AuthStep2Submit" /><input type="button" class="AuthCancelButton" value="Cancel" /><br />
</div>{% endhighlight %}</li>
<li>Finally, update the challenge handler accordingly.<br />
In this example, a new challenge handler (a new <code>.js</code> file), called <code>TwoStepAuthRealmChallengeProcessor.js</code>, is created for this purpose.</p>
<ul>
<li>The response is checked as in the original sample application:
<p>{% highlight js %}<br />
var TwoStepAuthRealmChallengeHandler = WL.Client.createChallengeHandler("TwoStepAuthRealm");</p>
<p>TwoStepAuthRealmChallengeHandler.isCustomResponse = function(response) {<br />
	if (!response || !response.responseJSON	|| response.responseText === null) {<br />
		return false;<br />
	}<br />
	if (typeof(response.responseJSON.authRequired) !== 'undefined'){<br />
		return true;<br />
	} else {<br />
		return false;<br />
	}<br />
};{% endhighlight %}</li>
<li>Add another case for the second authentication step:<br />
{% highlight js %}<br />
TwoStepAuthRealmChallengeHandler.handleChallenge = function(response){<br />
	var authRequired = response.responseJSON.authRequired;</p>
<p>	if (authRequired == true){<br />
		$("#AppDiv").hide();<br />
		$("#AuthDiv").show();<br />
		$("#AuthInfo").empty();</p>
<p>		$("#AuthStep1Div").hide();<br />
		$("#AuthStep2Div").hide();<br />
		switch (response.responseJSON.authStep) {<br />
			case 1:<br />
				$("#AuthStep1Div").show();<br />
				$("#AuthPassword").val('');<br />
				break;<br />
			case 2:<br />
				$("#AuthStep2Div").show();<br />
				$("#AuthAnswer").val('');<br />
				$("#AuthQuestion").html(response.responseJSON.question);<br />
				break;<br />
		}</p>
<p>		if (response.responseJSON.errorMessage)<br />
			$("#AuthInfo").html(response.responseJSON.errorMessage);</p>
<p>	} else if (authRequired == false){<br />
		$("#AppDiv").show();<br />
		$("#AuthDiv").hide();<br />
		TwoStepAuthRealmChallengeHandler.submitSuccess();<br />
	}<br />
};{% endhighlight %}</li>
<li>Perform the second authentication step:<br />
{% highlight js %}<br />
$("#AuthStep1Submit").bind('click', function () {<br />
	var username = $("#AuthUsername").val();<br />
	var password = $("#AuthPassword").val();</p>
<p>	var invocationData = {<br />
		adapter : "AuthAdapter",<br />
		procedure : "submitAuthenticationStep1",<br />
		parameters : [ username, password ]<br />
	};</p>
<p>	TwoStepAuthRealmChallengeHandler.submitAdapterAuthentication(invocationData, {});<br />
});</p>
<p>$("#AuthStep2Submit").bind('click', function () {<br />
	var answer = $("#AuthAnswer").val();</p>
<p>	var invocationData = {<br />
		adapter : "AuthAdapter",<br />
		procedure : "submitAuthenticationStep2",<br />
		parameters : [ answer ]<br />
	};</p>
<p>	TwoStepAuthRealmChallengeHandler.submitAdapterAuthentication(invocationData, {});<br />
});</p>
<p>$(".AuthCancelButton").bind('click', function () {<br />
	$("#AppDiv").show();<br />
	$("#AuthDiv").hide();<br />
	TwoStepAuthRealmChallengeHandler.submitFailure();<br />
});<br />
{% endhighlight %}</li>
</ul>
</li>
</ol>
<p><br clear="all" /></p>
<blockquote><p>To review the remaining/existing sample client-side implementation, see the <a href="../../authentication-security/adapter-based-authentication/adapter-based-authentication-hybrid-applications/">Adapter-based authentication in hybrid applications</a>  tutorial.</p></blockquote>
<h2 id="sampleApplication">Sample application</h2>
<p><a href="https://github.com/MobileFirst-Platform-Developer-Center/TwoStepAuth">Click to download</a> the sample application.</p>
