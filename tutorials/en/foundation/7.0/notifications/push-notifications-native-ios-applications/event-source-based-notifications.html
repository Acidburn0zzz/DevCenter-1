---
layout: tutorial
title: Event source-based notifications in native Windows 8 applications
date: 2015-01-07 10:48:38.000000000 +02:00
type: tutorial
published: true
status: publish
categories: []
tags:
- 7-0
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '6643'
  _wpas_done_all: '1'
  _syntaxhighlighter_encoded: '1'
author:
  login: nathanh@il.ibm.com
  email: NATHANH@il.ibm.com
  display_name: Nathan Hazout
  first_name: NATHAN
  last_name: HAZOUT
---

<div id="samplesAndPersonas">
<div>
    Relevant to:
    <ul id="relevantForPersona">
        <li class="ios">Native iOS</li>
    </ul>
</div>
    <ul>
    <li class="download-sample">
      <a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v700/PushNotificationsNativeProject.zip">Download Studio project</a>
    </li>
    <li class="download-sample">
      <a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v700/iOSNativePushProject.zip">Download native project</a>
    </li>
</ul>
</div>

<h2>Overview</h2>
Event source notifications are notification messages that are targeted to devices with a user subscription.

To learn more about the architecture and terminology of push notifications in MobileFirst Platform, refer to the “<a href="/mobilefirstplatform/documentation/getting-started-7-0/notifications/push-notifications-hybrid-applications/event-source-based-notifications/">Event source-based notifications in hybrid applications</a>” tutorial.

Jump to:
<ul>
    <li><a href="#serverSideApi">Notification API - Server-side</a></li>
    <li><a href="#clientSideApi">Notification API - Client-side</a></li>
    <li><a href="#sample">Sample application</a></li>
</ul>

While the user subscription exists, MobileFirst Server can produce push notifications for the subscribed user. These notifications can be delivered by the adapter code to all or some of the devices from which the user subscribed.

Implementation of the push notification API consists of the following main steps:

<h4>On the server side:</h4>
<ul>
<li><em>Creating an event source</em></li>
<li><em>Sending notification</em></li>
</ul>

<h4>On the client side:</h4>
<ul>
<li><em>Sending the token and initializing the </em><code>WLPush</code><em> class</em></li>
<li><em>Registering the event source</em></li>
<li><em>Subscribing to/unsubscribing from the event source</em></li>
</ul>

<h2 id="serverSideApi">Notification API: Server-side</h2>

<h3>Creating an event source</h3>
This can be achieved by creating a notification event source in the adapter JavaScript™ code at a global level (outside any JavaScript function).
[code lang="js"]
WL.Server.createEventSource({
    name: 'PushEventSource',
    onDeviceSubscribe: 'deviceSubscribeFunc',
    onDeviceUnsubscribe: 'deviceUnsubscribeFunc',
    securityTest:'PushApplication-strong-mobile-securityTest'
});
[/code]

<ul>
<li><code>name </code>– A name by which the event source is referenced.</li>
<li><code>onDeviceSubscribe</code> – An adapter function that is called when the request for user subscription is received.</li>
<li><code>onDeviceUnsubscribe</code> – An adapter function that is called when the request for user unsubscription is received.</li>
<li><code>securityTest</code> – A security test from the <strong>authenticationConfig.xml</strong> file that is used to protect the event source.</li></ul>

<h3>Sending a notification</h3>

Notifications can be either polled from, or pushed by, the back-end system. In this example, a <code>submitNotifications()</code> adapter function is invoked by a back-end system as an external API to send notifications.

[code lang="js"]function submitNotification(userId, notificationText) {
    var userSubscription = WL.Server.getUserNotificationSubscription('PushAdapter.PushEventSource', userId);

    if (userSubscription === null) {
        return { result: "No subscription found for user :: " + userId };
    }

    var badgeDigit = 1;
    var notification = WL.Server.createDefaultNotification(notificationText, badgeDigit, {custom:"data"});

        WL.Server.notifyAllDevices(userSubscription, notification);

    return {
        result: "Notification sent to user :: " + userId
    };
}[/code]

<h2 id="clientSideApi">Notification API: Client-side </h2>
A device subscription belongs to a user subscription and exists in the scope of a specific user and event source. A user subscription can have several device subscriptions.

The device subscription is created when the application on a device calls the <code>[[WLPush sharedInstance]subscribe]</code> method.

The device subscription is deleted either by an application that calls <code>[[WLPush sharedInstance] unsubscribe]</code> or when the push mediator informs MobileFirst Platform Server that the device is permanently not accessible.

<ol>
<li>Access the <code>WLPush</code> functionality by using <code>[WLPush sharedInstance]</code> anywhere in your application.

<br />
</li><li>Create an instance of <code>onReadyToSubscribeListener</code> and set values for alias, adaptername and eventsource.

[code lang="obj-c"]
ReadyToSubscribeListener *readyToSubscribeListener = [[ReadyToSubscribeListener alloc] initWithController:self];
  readyToSubscribeListener.alias = self.alias;
  readyToSubscribeListener.adapterName = self.adapterName;
  readyToSubscribeListener.eventSourceName = self.eventSourceName;
[/code]

</li><li>Set the <code>onReadyToSubscribeListener</code> on <code>WLPush</code>.

[code lang="obj-c"]
[[WLPush sharedInstance] setOnReadyToSubscribeListener:readyToSubscribeListener];
[/code]

</li><li>Pass the token to <span class="inline-code">WLPush</span>.
[code lang="obj-c"]
[[WLPush sharedInstance] setTokenFromClient:deviceToken.description];
[/code]
</li></ol>

<h3>Sending token to client and initializing <code>WLPush</code></h3>

The user must initialize the <code>WLPush sharedInstance</code> in the application's <code>ViewController</code> load method.
[code lang="obj-c"]
AppDelegate *appDelegate = [[UIApplication sharedApplication]delegate];
[[WLPush sharedInstance]init];
[/code]
The user must add this method to the app delegate to get the token.
[code lang="obj-c"]
-(void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken{
}
[/code]

The token that is received by this method must be passed to the WLPush method.
[code lang="obj-c"]
[[WLPush sharedInstance] setTokenFromClient:deviceToken.description];
[/code]

<h3>Registering the event source</h3>

IBM MobileFirst Platform Foundation provides the customizable <code>onReadyToSubscribe</code> function, which is used to register an event source.
Set up your <code>onReadyToSubscribe</code> function in Listener, which implements <code>WLOnReadyToSubscribeListener</code>.

This function is called when authentication finishes.
[code lang="obj-c"]
#import "ReadyToSubscribeListener.h"
#import "MyEventSourceListener.h"

@implementation ReadyToSubscribeListener

-(void)OnReadyToSubscribe{
  MyEventSourceListener *eventSourceListener=[[MyEventSourceListener alloc]init];
  [[WLPush sharedInstance] registerEventSourceCallback:self.alias :self.adapterName
  :self.eventSourceName :eventSourceListener];
}

@end
[/code]

<br clear="all"/>

<h3>Subscribing to the event source</h3>

<strong>Prerequisite:</strong> To subscribe, a user must authenticate.

To set up subscription to the event source, use the following API:
[code lang="obj-c"]
- (IBAction)subscribe:(id)sender {
  MySubscribeListener *mySubscribeListener = [[MySubscribeListener alloc] initWithController:self];
  [[WLPush sharedInstance]subscribe:self.alias :nil :mySubscribeListener];
}
[/code]

<span class="inline-code">[[WLPush sharedInstance] subscribe]</span> takes the following parameters:

<ul>
    <li>An alias, as declared in <code>[[WLPush sharedInstance] registerEventSourceCallback]</code></li>

    <li><code>WLPushOptions</code> - The instance contains the custom subscription parameters that the event source supports (optional).</li>

    <li><code>id <em>WLDelegate</em></code> - The listener object instance, whose <code>onSuccess</code> and <code>onFailure</code> callback methods are called (optional).</li>
</ul>

Delegates receive a response object if one is required.

<h3>Unsubscribing  from an event source</h3>

To set up unsubscription from an event source, use the following API:
[code lang="obj-c"]
- (IBAction)unsubscribe:(id)sender {
  MyUnsubscribeListener *myUnsubscribelistener = [[MyUnsubscribeListener alloc]initWithController:self];
  [[WLPush sharedInstance]unsubscribe:self.alias :myUnsubscribelistener];
}
[/code]
<span class="inline-code">[[WLPush sharedInstance] unsubscribe]</span> takes the following parameters:

<ul>
<li>An alias, as declared in <code>[[WLPush sharedInstance] registerEventSourceCallback]</code></li>

<li><code>id <em>WLDelegate</em></code> - The listener object instance, whose <code>onSuccess</code> and <code>onFailure</code> callback methods are called (optional)</li>

</ul>

Delegates receive a response object if one is required.

<h3>Additional client-side APIs</h3>

<span class="inline-code">[[WLPush sharedInstance]isPushSupported]</span> – Returns <code>true</code> if push notifications are supported by the platform, or <code>false</code> otherwise.
<span class="inline-code">[[WLPush sharedInstance]isSubscribed:alias]</span> – Returns whether the currently logged-in user is subscribed to a specified event source alias.
<br clear="all"/>
When a push notification is received by a device, the <span class="inline-code">didReceiveRemoteNotification</span> method  is called in the app delegate. Logic to handle the notification should be defined here.

[code lang="obj-c"]
-(void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo{
    NSLog(@"Received Notification %@",userInfo.description);
}
[/code]
If the application was in background mode (or inactive) when the push notification arrived, this callback is called when the application returns to the foreground.

<h2 id="sample">Sample application</h2>
<a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v700/PushNotificationsNativeProject.zip">Click to download</a> the Studio project.
<a href="http://public.dhe.ibm.com/software/products/en/MobileFirstPlatform/docs/v700/iOSNativePushProject.zip">Click to download</a> the Native project.

The sample contains two projects:
<ul>
    <li>The <strong>PushNotificationsNativeProject.zip</strong> file contains a MobileFirst native API that you can deploy to your MobileFirst server.</li>
    <li><strong>iOSNativePushProject.zip</strong> file contains a native iOS application that uses a MobileFirst native API library to subscribe for push notification and receive notifications from APNS. Make sure to update the <strong>worklight.plist</strong> file in iOSNativePush with the relevant server settings.</li>
</ul>

<a href="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2014/07/nativeiOSSampleRunmobilefirst.png"><img src="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2014/07/nativeiOSSampleRunmobilefirst.png" alt="nativeiOSSampleRunmobilefirst" width="1294" height="762" class="alignnone size-full wp-image-3960" /></a>

<a href="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2015/01/nativeiOSSendNotificationEventSource.png"><img src="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2015/01/nativeiOSSendNotificationEventSource.png" alt="nativeiOSSendNotificationEventSource" width="1188" height="684" class="alignleft size-full wp-image-6276" /></a>

<a href="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2014/07/nativeiOSPushAppRun2.png"><img src="http://developer.ibm.com/mobilefirstplatform/wp-content/uploads/sites/32/2014/07/nativeiOSPushAppRun2.png" alt="nativeiOSPushAppRun2" width="1300" height="765" class="alignnone size-full wp-image-3838" /></a>
